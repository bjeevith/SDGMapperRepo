<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDG Determinism Test</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Outfit', sans-serif; background: #0b0f1a; color: #e2e8f0; min-height: 100vh; padding: 40px 32px; }
    h1 { font-size: 26px; font-weight: 600; margin-bottom: 8px; }
    .mono { font-family: 'DM Mono', monospace; }
    .label { font-family: 'DM Mono', monospace; font-size: 11px; color: #64748b; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px; }
    .card { background: #111827; border: 1px solid #1e293b; border-radius: 10px; padding: 20px 24px; margin-bottom: 16px; }
    .goal-btn { display: block; width: 100%; text-align: left; background: transparent; border: 1px solid #1e293b; border-radius: 8px; padding: 12px 16px; cursor: pointer; color: #e2e8f0; margin-bottom: 8px; transition: all 0.15s; }
    .goal-btn:hover { border-color: #009edb; }
    .goal-btn.selected { background: #0c2a3d; border-color: #009edb; }
    .goal-org { font-family: 'DM Mono', monospace; font-size: 10px; color: #009edb; margin-bottom: 4px; }
    .goal-title { font-size: 13px; line-height: 1.4; }
    .run-btn { background: #009edb; color: #fff; border: none; border-radius: 6px; padding: 10px 24px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; cursor: pointer; }
    .run-btn:disabled { background: #1e293b; color: #475569; cursor: not-allowed; }
    .log { background: #0a0d14; border: 1px solid #1e293b; border-radius: 8px; padding: 14px 18px; margin-bottom: 16px; max-height: 150px; overflow-y: auto; }
    .log-line { font-family: 'DM Mono', monospace; font-size: 11px; color: #64748b; margin-bottom: 4px; }
    .scores { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .score-card { background: #111827; border: 1px solid #1e293b; border-radius: 10px; padding: 16px; text-align: center; }
    .score-card.overall-pass { background: #14532d; border-color: #22c55e; }
    .score-card.overall-fail { background: #450a0a; border-color: #ef4444; }
    .score-num { font-family: 'DM Mono', monospace; font-size: 36px; font-weight: 700; line-height: 1; margin-bottom: 8px; }
    .pass { color: #22c55e; }
    .warn { color: #f59e0b; }
    .fail { color: #ef4444; }
    .score-label { font-family: 'DM Mono', monospace; font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .score-desc { font-size: 11px; color: #475569; }
    .runs-grid { display: grid; gap: 10px; margin-bottom: 20px; }
    .run-col { background: #111827; border: 1px solid #1e293b; border-radius: 8px; padding: 14px; }
    .run-title { font-family: 'DM Mono', monospace; font-size: 10px; color: #009edb; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .sdg-pill { padding: 6px 10px; background: #1c2537; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #009edb; font-family: 'DM Mono', monospace; font-size: 11px; color: #64748b; }
    .sdg-pill.secondary { border-left-color: #475569; }
    .tradeoff-pill { padding: 6px 10px; background: #1c2537; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #ef4444; }
    .rec-pill { padding: 8px 10px; background: #1c2537; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #7c3aed; font-size: 11px; color: #94a3b8; line-height: 1.5; }
    .rec-num { font-family: 'DM Mono', monospace; font-size: 9px; color: #a78bfa; margin-bottom: 3px; }
    .error { background: #450a0a; border: 1px solid #ef4444; border-radius: 8px; padding: 12px 16px; font-size: 13px; color: #fca5a5; margin-bottom: 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { width: 14px; height: 14px; border: 2px solid #1e293b; border-top-color: #009edb; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
    .fade { animation: fadeUp 0.3s ease; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>

  <div style="margin-bottom:32px;">
    <div class="mono" style="font-size:11px;color:#009edb;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;">SDG Goal Mapper — Developer Tool</div>
    <h1>Determinism Test Harness</h1>
    <p style="color:#64748b;font-size:14px;line-height:1.7;margin-top:8px;">
      Runs the same goal 3× with <code style="background:#1c2537;padding:1px 6px;border-radius:4px;color:#86efac;">temperature: 0</code> and scores structural + semantic similarity. Target: ≥90% overall.
    </p>
  </div>

  <div class="card">
    <div class="label">Select Test Goal</div>
    <button class="goal-btn selected" id="goal-0" onclick="selectGoal(0)">
      <div class="goal-org">Amazon</div>
      <div class="goal-title">Reach net-zero carbon across our operations and value chain by 2040</div>
    </button>
    <button class="goal-btn" id="goal-1" onclick="selectGoal(1)">
      <div class="goal-org">Google</div>
      <div class="goal-title">Operate on 24/7 carbon-free energy on every grid where we operate by 2030</div>
    </button>
    <button class="goal-btn" id="goal-2" onclick="selectGoal(2)">
      <div class="goal-org">Microsoft</div>
      <div class="goal-title">Be carbon negative by 2030, and by 2050 remove all historical emissions since company founding</div>
    </button>
    <div style="margin-top:16px;">
      <button class="run-btn" id="run-btn" onclick="runTest()">▶ Run 3× and score</button>
    </div>
  </div>

  <div id="log-area" style="display:none;" class="log"></div>
  <div id="error-area" style="display:none;" class="error"></div>
  <div id="results" style="display:none;"></div>

  <script>
    const VERCEL_URL = "https://sdg-mapper-repo.vercel.app/api/claude";
    const THRESHOLD = 90;
    const GOALS = [
      { org: "Amazon",    title: "Reach net-zero carbon across our operations and value chain by 2040" },
      { org: "Google",    title: "Operate on 24/7 carbon-free energy on every grid where we operate by 2030" },
      { org: "Microsoft", title: "Be carbon negative by 2030, and by 2050 remove all historical emissions since company founding" },
    ];

    let selectedGoal = 0;

    function selectGoal(i) {
      document.querySelectorAll('.goal-btn').forEach((b, j) => b.classList.toggle('selected', i === j));
      selectedGoal = i;
    }

    function buildPrompt(org, title) {
      return `You are a senior UN SDG analyst with deep expertise in corporate sustainability, ecology, supply chains, and systems thinking. Your role is to produce rigorous, non-obvious SDG analysis — not generic sustainability consulting.

ORG: ${org}
GOAL: "${title}"

STEP 1 — REASON THROUGH THESE LENSES BEFORE WRITING OUTPUT:

A) DIRECT SDG LINKS: Which SDGs does this goal directly advance? Be precise about causal mechanism.
B) SECOND-ORDER EFFECTS: What happens downstream? (e.g. solar goal → land use for panels → pollinator habitat disruption → SDG 15; wind energy → turbine blade bird mortality → SDG 15.5; EV batteries → cobalt mining → child labour → SDG 8.7; data centres for AI → water cooling → SDG 6.4)
C) SUPPLY CHAIN TENSIONS: What upstream or downstream supply chain harms does this goal create or ignore?
D) EQUITY & JUSTICE LENS: Does this goal risk exacerbating inequality?
E) BIODIVERSITY & ECOSYSTEM LENS: Always check SDG 14 and 15 even for non-environmental goals.
F) WHAT WOULD MAKE THIS GOAL TRULY TRANSFORMATIVE: What specific, measurable actions referencing real UN indicator numbers would move the needle?

STEP 2 — OUTPUT only this JSON. No prose. Must start with { and end with }:

{"sdgMappings":[{"sdgId":7,"sdgName":"Affordable & Clean Energy","type":"primary","confidence":"High","reasoning":"2-3 sentence causal explanation."}],"positiveImpacts":[{"targetId":"7.2","targetText":"Increase substantially the share of renewable energy","indicator":"7.2.1","mechanism":"Specific mechanism."}],"negativeTradeoffs":[{"targetId":"15.5","targetText":"Halt biodiversity loss","mechanism":"Concrete second-order causal pathway.","severity":"Moderate tension"}],"targetsTable":[{"targetId":"7.2","targetText":"Brief description","direction":"positive","indicator":"7.2.1"}],"recommendations":["Specific recommendation referencing a real UN indicator and program type.","Recommendation addressing equity/justice dimension.","Recommendation to extend coverage to an uncovered SDG.","Recommendation referencing a real industry standard or certification."]}

STRICT RULES:
- sdgMappings: 2-4 SDGs. type = "primary" or "secondary". confidence = "High", "Medium", or "Low".
- positiveImpacts: 2-4 items with real UN SDG target IDs.
- negativeTradeoffs: 1-3 items. severity = exactly "Minor friction", "Moderate tension", or "Significant risk". Never return [].
- recommendations: exactly 4 strings, each referencing a real UN indicator, certification, or program.
- Return ONLY valid JSON. No markdown.`;
    }

    async function callAPI(org, title) {
      const res = await fetch(VERCEL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 8000,
          temperature: 0,
          messages: [{ role: "user", content: buildPrompt(org, title) }],
        }),
      });
      const data = await res.json();
      const text = (data.content || []).filter(b => b.type === "text").map(b => b.text).join("\n");
      const clean = text.replace(/```json\s*/gi, "").replace(/```\s*/g, "").trim();
      const start = clean.search(/[{\[]/);
      const end = Math.max(clean.lastIndexOf("}"), clean.lastIndexOf("]"));
      return JSON.parse(clean.slice(start, end + 1));
    }

    function setOf(arr) { return new Set(arr.map(x => String(x))); }
    function jaccard(a, b) {
      if (a.size === 0 && b.size === 0) return 100;
      const inter = new Set([...a].filter(x => b.has(x)));
      const union = new Set([...a, ...b]);
      return Math.round((inter.size / union.size) * 100);
    }
    function tokenize(str) {
      return new Set(str.toLowerCase().replace(/[^a-z0-9\s]/g, "").split(/\s+/).filter(w => w.length > 3));
    }
    function textSim(a, b) { return jaccard(tokenize(a), tokenize(b)); }
    function avg(arr) { return Math.round(arr.reduce((s, x) => s + x, 0) / arr.length); }

    function scoreRuns(runs) {
      const pairs = [[0,1],[0,2],[1,2]];
      const sdgIds = [], sdgTypes = [], tradeoffIds = [], recText = [];
      pairs.forEach(([i, j]) => {
        const a = runs[i], b = runs[j];
        sdgIds.push(jaccard(setOf((a.sdgMappings||[]).map(m=>m.sdgId)), setOf((b.sdgMappings||[]).map(m=>m.sdgId))));
        sdgTypes.push(jaccard(setOf((a.sdgMappings||[]).map(m=>`${m.sdgId}:${m.type}`)), setOf((b.sdgMappings||[]).map(m=>`${m.sdgId}:${m.type}`))));
        tradeoffIds.push(jaccard(setOf((a.negativeTradeoffs||[]).map(t=>t.targetId)), setOf((b.negativeTradeoffs||[]).map(t=>t.targetId))));
        const aR = a.recommendations||[], bR = b.recommendations||[];
        const sims = aR.map((r,k) => bR[k] ? textSim(r, bR[k]) : 0);
        recText.push(sims.length ? avg(sims) : 0);
      });
      return { sdgIds: avg(sdgIds), sdgTypes: avg(sdgTypes), tradeoffIds: avg(tradeoffIds), recText: avg(recText), overall: avg([avg(sdgIds), avg(sdgTypes), avg(tradeoffIds), avg(recText)]) };
    }

    function colorForScore(s) { return s >= THRESHOLD ? 'pass' : s >= 70 ? 'warn' : 'fail'; }

    function addLog(msg) {
      const el = document.getElementById('log-area');
      el.style.display = 'block';
      el.innerHTML += `<div class="log-line">${new Date().toLocaleTimeString()} — ${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    async function runTest() {
      const goal = GOALS[selectedGoal];
      const btn = document.getElementById('run-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Running…';
      document.getElementById('log-area').innerHTML = '';
      document.getElementById('log-area').style.display = 'block';
      document.getElementById('error-area').style.display = 'none';
      document.getElementById('results').style.display = 'none';

      const runs = [];
      for (let i = 0; i < 3; i++) {
        addLog(`Run ${i+1}/3 started…`);
        try {
          const result = await callAPI(goal.org, goal.title);
          runs.push(result);
          addLog(`Run ${i+1} ✓ — ${result.sdgMappings?.length} SDGs, ${result.negativeTradeoffs?.length} trade-offs`);
        } catch (e) {
          const err = document.getElementById('error-area');
          err.style.display = 'block';
          err.textContent = `Run ${i+1} failed: ${e.message}`;
          btn.disabled = false;
          btn.innerHTML = '▶ Run 3× and score';
          return;
        }
        if (i < 2) await new Promise(r => setTimeout(r, 1500));
      }

      const s = scoreRuns(runs);
      addLog(`Done — overall similarity: ${s.overall}% (target: ${THRESHOLD}%)`);

      const resultsEl = document.getElementById('results');
      resultsEl.style.display = 'block';
      resultsEl.className = 'fade';

      const overallClass = s.overall >= THRESHOLD ? 'overall-pass' : 'overall-fail';
      const dims = [
        { label: "SDG IDs matched",         score: s.sdgIds,      desc: "Same SDGs identified" },
        { label: "Primary/Secondary types",  score: s.sdgTypes,    desc: "Same type assigned" },
        { label: "Trade-off targets",        score: s.tradeoffIds, desc: "Same tensions flagged" },
        { label: "Recommendation text",      score: s.recText,     desc: "Similar wording" },
        { label: "OVERALL",                  score: s.overall,     desc: `Target ≥${THRESHOLD}%`, overall: true },
      ];

      resultsEl.innerHTML = `
        <div class="label">Similarity Scores (avg across 3 pairwise comparisons)</div>
        <div class="scores">
          ${dims.map(d => `
            <div class="score-card ${d.overall ? overallClass : ''}">
              <div class="score-num ${colorForScore(d.score)}">${d.score}%</div>
              <div class="score-label">${d.label}</div>
              <div class="score-desc">${d.desc}</div>
              ${d.overall ? `<div style="margin-top:8px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;" class="${colorForScore(d.score)}">${d.score >= THRESHOLD ? `✓ PASSES ${THRESHOLD}% threshold` : `✗ BELOW ${THRESHOLD}% threshold`}</div>` : ''}
            </div>
          `).join('')}
        </div>

        <div class="label">SDG Mappings — All 3 Runs</div>
        <div class="runs-grid" style="grid-template-columns:repeat(3,1fr);">
          ${runs.map((run, i) => `
            <div class="run-col">
              <div class="run-title">Run ${i+1}</div>
              ${(run.sdgMappings||[]).map(m => `
                <div class="sdg-pill ${m.type === 'secondary' ? 'secondary' : ''}">
                  SDG ${m.sdgId} · ${m.type} · ${m.confidence}
                </div>
              `).join('')}
            </div>
          `).join('')}
        </div>

        <div class="label">Trade-offs — All 3 Runs</div>
        <div class="runs-grid" style="grid-template-columns:repeat(3,1fr);">
          ${runs.map((run, i) => `
            <div class="run-col">
              <div class="run-title">Run ${i+1}</div>
              ${(run.negativeTradeoffs||[]).map(t => `
                <div class="tradeoff-pill">
                  <div style="font-family:'DM Mono',monospace;font-size:11px;color:#ef4444;">${t.targetId}</div>
                  <div style="font-size:11px;color:#94a3b8;margin-top:2px;">${t.severity}</div>
                  <div style="font-size:11px;color:#64748b;margin-top:4px;line-height:1.4;">${t.mechanism}</div>
                </div>
              `).join('')}
            </div>
          `).join('')}
        </div>

        <div class="label">Recommendations — All 3 Runs</div>
        <div class="runs-grid" style="grid-template-columns:repeat(3,1fr);">
          ${runs.map((run, i) => `
            <div class="run-col">
              <div class="run-title">Run ${i+1}</div>
              ${(run.recommendations||[]).map((r, j) => `
                <div class="rec-pill">
                  <div class="rec-num">REC ${j+1}</div>
                  ${r}
                </div>
              `).join('')}
            </div>
          `).join('')}
        </div>
      `;

      btn.disabled = false;
      btn.innerHTML = '▶ Run again';
    }
  </script>
</body>
</html>
